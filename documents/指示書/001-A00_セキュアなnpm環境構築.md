# セキュア環境構築ガイド

## ⚠️ セキュリティ重要事項

### 2024年9月npmマルウェア事件について

2024年9月8日、18種類の人気npmパッケージに悪意のあるコードが埋め込まれる事件が発生しました。影響を受けたパッケージには以下が含まれます：

- chalk, debug, ansi-styles（多くのプロジェクトで使用される基盤パッケージ）
- supports-color, strip-ansi, wrap-ansi など

このガイドでは、**2025年8月より前の安全なバージョン**のみを使用し、セキュリティリスクを最小化します。

---

## 1. 前提条件

### 1.1 対象環境
- OS: Windows 10/11（まっさらな状態）
- Node.js: 未インストール
- npm: 未インストール
- エディタ: Visual Studio Code（推奨）

### 1.2 セキュリティ方針
1. LTS（Long Term Support）バージョンのみ使用
2. 特定バージョンの固定（--save-exact）
3. 依存関係の脆弱性チェック
4. 最小限のパッケージ構成

---

## 2. Node.js のインストール

### 2.1 安全なNode.jsバージョンの選択

**推奨バージョン**: Node.js 20.12.2 LTS（2024年4月リリース）

**ダウンロード先**:
- 公式サイト: https://nodejs.org/
- 直接リンク: https://nodejs.org/dist/v20.12.2/node-v20.12.2-x64.msi

### 2.2 インストール手順

1. **MSIファイルのダウンロード**
   ```
   ファイル名: node-v20.12.2-x64.msi
   サイズ: 約 28MB
   SHA256: [公式サイトで確認]
   ```

2. **インストーラーの実行**
   - 管理者権限で実行
   - デフォルト設定でインストール
   - PATH環境変数の自動設定を確認

3. **インストール確認**
   ```cmd
   node --version
   # v20.12.2 と表示されることを確認

   npm --version
   # 10.5.0 と表示されることを確認
   ```

---

## 3. プロジェクト初期化

### 3.1 プロジェクトディレクトリの作成

```cmd
cd C:\Users\[ユーザー名]\Documents
mkdir simulation_app
cd simulation_app
mkdir frontend
cd frontend
```

### 3.2 package.json の手動作成

セキュリティのため、推奨バージョンを手動で指定します：

```json
{
  "name": "frontend",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "audit": "npm audit"
  },
  "dependencies": {
    "next": "14.2.33",
    "react": "18.3.1",
    "react-dom": "18.3.1"
  },
  "devDependencies": {
    "@types/node": "20.14.2",
    "@types/react": "18.3.3",
    "@types/react-dom": "18.3.0",
    "eslint": "8.57.0",
    "eslint-config-next": "14.2.33",
    "typescript": "5.4.5"
  }
}
```

---

## 4. セキュアなパッケージインストール

### 4.1 npmレジストリの確認

```cmd
npm config get registry
# https://registry.npmjs.org/ であることを確認
```

### 4.2 パッケージのインストール

**重要**: 特定バージョンを固定してインストール

```cmd
# 本体パッケージ
npm install next@14.2.33 react@18.3.1 react-dom@18.3.1 --save-exact

# 開発依存関係
npm install --save-dev --save-exact typescript@5.4.5 @types/react@18.3.3 @types/react-dom@18.3.0 @types/node@20.14.2

# ESLint関連
npm install --save-dev --save-exact eslint@8.57.0 eslint-config-next@14.2.33
```

### 4.3 セキュリティチェック

```cmd
# 脆弱性チェック
npm audit

# 結果が「found 0 vulnerabilities」であることを確認
```

---

## 5. Next.js設定ファイル

### 5.1 tsconfig.json

```json
{
  "compilerOptions": {
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

### 5.2 next.config.js

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
}

module.exports = nextConfig
```

### 5.3 .eslintrc.json

```json
{
  "extends": "next/core-web-vitals"
}
```

---

## 6. gitignore設定

### 6.1 .gitignore

```gitignore
# dependencies
/node_modules
/.pnp
.pnp.js

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# local env files
.env*.local

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts

# セキュリティ強化のため
.env
.env.production
```

---

## 7. セキュリティ強化策

### 7.1 package-lock.json の管理

```cmd
# package-lock.jsonを生成
npm install

# package-lock.jsonをgitで管理（推奨）
git add package-lock.json
```

### 7.2 定期的なセキュリティチェック

```cmd
# 脆弱性チェック
npm audit

# パッケージの更新確認
npm outdated
```

### 7.3 環境変数の管理

```bash
# .env.local （gitignoreに含まれる）
NEXT_PUBLIC_API_URL=http://localhost:8000
```

---

## 8. 推奨開発ツール

### 8.1 Visual Studio Code

**拡張機能**:
- ES7+ React/Redux/React-Native snippets
- TypeScript Importer
- Auto Rename Tag
- Prettier - Code formatter
- ESLint

### 8.2 ブラウザ開発者ツール

**推奨ブラウザ**:
- Google Chrome（React Developer Tools対応）
- Microsoft Edge（Chromiumベース）

---

## 9. トラブルシューティング

### 9.1 よくある問題と解決法

#### 問題1: npm installが失敗する
```cmd
# npmキャッシュをクリア
npm cache clean --force

# .npmrcファイルを確認
npm config list
```

#### 問題2: TypeScriptエラー
```cmd
# TypeScriptサーバーを再起動
npx tsc --noEmit
```

#### 問題3: Next.jsが起動しない
```cmd
# .nextディレクトリを削除
rmdir /s .next
npm run dev
```

### 9.2 セキュリティ関連の問題

#### npm auditで脆弱性が検出された場合
```cmd
# 詳細確認
npm audit --audit-level moderate

# 自動修正（慎重に実行）
npm audit fix

# 手動修正が必要な場合は個別に対応
```

---

## 10. 動作確認

### 10.1 開発サーバーの起動

```cmd
npm run dev
```

### 10.2 ブラウザでの確認

1. http://localhost:3000 にアクセス
2. 開発者ツールでエラーがないことを確認
3. ネットワークタブで不審な通信がないことを確認

---

## 11. セキュリティチェックリスト

### 11.1 インストール前
- [ ] Node.js LTSバージョンの確認
- [ ] 公式サイトからのダウンロード
- [ ] SHA256ハッシュの確認

### 11.2 プロジェクト作成後
- [ ] package.jsonの依存関係確認
- [ ] npm auditでの脆弱性チェック
- [ ] .gitignoreの設定確認
- [ ] 環境変数の適切な管理

### 11.3 継続的なセキュリティ
- [ ] 定期的なnpm auditの実行
- [ ] セキュリティアップデートの追跡
- [ ] 不要なパッケージの削除

---

## まとめ

このガイドに従うことで、セキュリティリスクを最小化した開発環境を構築できます。特に重要なのは：

1. **バージョン固定**: 特定の安全なバージョンを使用
2. **脆弱性監視**: 定期的なnpm auditの実行
3. **最小構成**: 必要最小限のパッケージのみインストール
4. **継続的チェック**: セキュリティ情報の定期的な確認

セキュリティは一度設定すれば終わりではなく、継続的な監視と更新が必要です。

---

**作成日**: 2024年9月
**対象バージョン**: Node.js 20.12.2 LTS, Next.js 14.2.33
**最終更新**: 2024年9月