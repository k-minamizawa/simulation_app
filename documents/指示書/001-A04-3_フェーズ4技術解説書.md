# フェーズ4 技術解説書

## 1. React基礎概念

### 1.1 useState フック

**概要**: コンポーネントの状態を管理するための React Hook

```typescript
const [state, setState] = useState<T>(initialValue)
```

**学習ポイント**:
- `state`: 現在の状態値
- `setState`: 状態を更新する関数
- `<T>`: TypeScriptの型定義（ジェネリクス）

**実装例（今回のプロジェクトより）**:
```typescript
// frontend/src/app/start/page.tsx
const [isLoading, setIsLoading] = useState(false)
const [error, setError] = useState<string | null>(null)
```

### 1.2 条件付きレンダリング

**3つのパターン**:

#### パターン1: 三項演算子
```typescript
{isLoading ? '処理中...' : 'シミュレーションを開始'}
```
- 条件に応じて異なる要素を表示
- 常に何かを表示する場合に使用

#### パターン2: 論理AND演算子
```typescript
{error && (
  <p>{error}</p>
)}
```
- 条件が真の場合のみ要素を表示
- 表示/非表示を切り替える場合に使用

#### パターン3: 早期リターン
```typescript
if (loading) {
  return <LoadingComponent />
}
return <MainComponent />
```
- コンポーネント全体の表示を切り替える

## 2. Next.js App Router

### 2.1 ディレクトリベースのルーティング

```
src/app/
├── page.tsx          → /
├── layout.tsx        → 共通レイアウト
├── start/
│   └── page.tsx     → /start
└── results/
    └── page.tsx     → /results
```

**特徴**:
- ファイルシステムがそのままURLパスになる
- `page.tsx`が各ルートのエントリーポイント
- `layout.tsx`が子ページの共通レイアウト

### 2.2 'use client' ディレクティブ

```typescript
'use client'
```

**意味**: このコンポーネントはクライアントサイドで実行される

**使用する場面**:
- `useState`、`useEffect`などのHooksを使う時
- イベントハンドラー（onClick等）を使う時
- ブラウザAPIを使う時

## 3. TypeScript活用

### 3.1 インターフェース定義

```typescript
export interface ScenarioResult {
  scenario_id: number
  scenario_name: string
  average_total_costs: number
  average_delivery_rate: number
}
```

**メリット**:
- 型安全性の確保
- 自動補完の有効化
- リファクタリングの安全性

### 3.2 React.CSSProperties

```typescript
const styles: React.CSSProperties = {
  display: 'flex',
  fontSize: 'var(--font-size-lg)'
}
```

**利点**:
- CSSプロパティの型チェック
- 誤ったプロパティ名の検出
- 値の型チェック

## 4. コンポーネント設計

### 4.1 Props インターフェース

```typescript
interface ButtonProps {
  children: React.ReactNode
  onClick?: () => void
  variant?: 'primary' | 'secondary'
  disabled?: boolean
}
```

**設計原則**:
- 必須プロパティと任意プロパティの区別（`?`）
- デフォルト値の活用
- 単一責任の原則

### 4.2 コンポーネントの再利用性

```typescript
// 汎用的なButtonコンポーネント
<Button variant="primary" onClick={handleClick}>
  送信
</Button>

// 別の場所で再利用
<Button variant="secondary" disabled={isLoading}>
  キャンセル
</Button>
```

## 5. CSS変数による一貫性

### 5.1 グローバルCSS変数定義

```css
:root {
  --color-main: #004d99;
  --spacing-md: 1rem;
  --font-size-lg: 1.125rem;
}
```

### 5.2 使用方法

```typescript
style={{
  color: 'var(--color-main)',
  padding: 'var(--spacing-md)',
  fontSize: 'var(--font-size-lg)'
}}
```

**メリット**:
- 一箇所で色を変更すれば全体に反映
- デザインの一貫性
- メンテナンスの容易さ

## 6. エラーハンドリングパターン

### 6.1 Try-Catch-Finally

```typescript
const handleStartSimulation = () => {
  setIsLoading(true)
  setError(null)

  try {
    // API呼び出し処理
  } catch (error) {
    setError('エラーが発生しました')
  } finally {
    setIsLoading(false)
  }
}
```

**ポイント**:
- `try`: 正常処理
- `catch`: エラー処理
- `finally`: 必ず実行される処理

### 6.2 非同期処理（フェーズ5で実装予定）

```typescript
const handleStartSimulation = async () => {
  setIsLoading(true)
  setError(null)

  try {
    const response = await fetch('/api/simulation/start')
    const data = await response.json()
    // データ処理
  } catch (error) {
    setError('エラーが発生しました')
  } finally {
    setIsLoading(false)
  }
}
```

## 7. 学習のポイント

### 7.1 理解すべき概念

1. **状態管理**: Reactコンポーネントの状態とその更新方法
2. **Props**: 親から子へのデータの受け渡し
3. **イベントハンドリング**: ユーザー操作への応答
4. **条件付きレンダリング**: 動的なUI表示

### 7.2 次のステップ（フェーズ5）

1. **useEffect Hook**: 副作用の処理
2. **カスタムHook**: ロジックの共通化
3. **Context API**: グローバル状態管理
4. **API連携**: fetch/axiosによるデータ取得

## 8. トラブルシューティング

### 8.1 よくあるエラーと対処法

#### エラー1: "Cannot read property of undefined"
```typescript
// 間違い
{result.data.value}

// 正しい（オプショナルチェイニング）
{result?.data?.value}
```

#### エラー2: "Too many re-renders"
```typescript
// 間違い（無限ループ）
<Button onClick={handleClick()}>

// 正しい（関数参照）
<Button onClick={handleClick}>
```

#### エラー3: "Hydration failed"
```typescript
// サーバーとクライアントで異なる内容をレンダリング
// 解決: 'use client'を追加
```

## 9. パフォーマンス最適化のヒント

### 9.1 コンポーネントの最適化

```typescript
// メモ化されたコンポーネント（将来的な実装）
import { memo } from 'react'

const Card = memo(({ title, cost, deliveryRate }) => {
  // コンポーネントの実装
})
```

### 9.2 画像の最適化

```typescript
import Image from 'next/image'

<Image
  src="/logo.png"
  alt="Logo"
  width={200}
  height={100}
  priority
/>
```

## 10. まとめ

このフェーズで学んだ技術は、モダンなWebアプリケーション開発の基礎となります。特に重要なのは：

1. **React Hooks**: 関数コンポーネントでの状態管理
2. **TypeScript**: 型安全なコード記述
3. **コンポーネント設計**: 再利用可能なUI部品
4. **エラーハンドリング**: ユーザー体験の向上

これらの技術を組み合わせることで、保守性が高く、拡張可能なアプリケーションを構築できます。

---

**参考資料**:
- [React公式ドキュメント](https://react.dev/)
- [Next.js公式ドキュメント](https://nextjs.org/docs)
- [TypeScript公式ドキュメント](https://www.typescriptlang.org/docs/)